<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Акселерометр</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
        }
        #dataOutput {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>Сбор данных с акселерометра</h1>
    <button onclick="startCollecting()">Начать сбор</button>
    <button onclick="stopCollecting()">Остановить</button>
    <button onclick="downloadData()">Скачать данные</button>
    <div id="dataOutput">Ожидание данных...</div>

    <script>
        let collecting = false;
        let motionData = [];
        let intervalId = null;

        // Проверка поддержки и запрос разрешения
        function startCollecting() {
            if (typeof DeviceMotionEvent !== 'undefined') {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    // Для iOS 13+
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startMotionListener();
                            } else {
                                alert('Разрешение на доступ к акселерометру отклонено.');
                            }
                        })
                        .catch(console.error);
                } else {
                    // Для Android и других устройств
                    startMotionListener();
                }
            } else {
                alert('Ваш браузер или устройство не поддерживает акселерометр.');
            }
        }

        // Начало сбора данных
        function startMotionListener() {
            if (!collecting) {
                collecting = true;
                motionData = []; // Очищаем старые данные
                document.getElementById('dataOutput').innerText = 'Сбор данных начался...';

                window.addEventListener('devicemotion', handleMotion);
                // Собираем данные каждые 100 мс
                intervalId = setInterval(() => {
                    document.getElementById('dataOutput').innerText = 
                        `Последние данные: X: ${motionData[motionData.length - 1]?.x || 0}, ` +
                        `Y: ${motionData[motionData.length - 1]?.y || 0}, ` +
                        `Z: ${motionData[motionData.length - 1]?.z || 0}`;
                }, 100);
            }
        }

        // Обработка данных акселерометра
        function handleMotion(event) {
            if (collecting) {
                const accel = event.accelerationIncludingGravity || {};
                motionData.push({
                    time: new Date().toISOString(),
                    x: accel.x || 0,
                    y: accel.y || 0,
                    z: accel.z || 0
                });
            }
        }

        // Остановка сбора
        function stopCollecting() {
            if (collecting) {
                collecting = false;
                clearInterval(intervalId);
                window.removeEventListener('devicemotion', handleMotion);
                document.getElementById('dataOutput').innerText = 'Сбор данных остановлен.';
            }
        }

        // Скачивание данных в CSV
        function downloadData() {
            if (motionData.length === 0) {
                alert('Нет данных для скачивания!');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," +
                "Time,X,Y,Z\n" +
                motionData.map(row => `${row.time},${row.x},${row.y},${row.z}`).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "accelerometer_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
